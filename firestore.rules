/**
 * This ruleset enforces a strict security model for a Family Finance Tracker application.
 *
 * Core Philosophy:
 * The security model is built on three-tier Role-Based Access Control:
 * 1. MASTER: Full control - can create/edit/delete everything, manage all users
 * 2. ADMIN: Management access - can view all data, manage content, but cannot delete users or change master settings
 * 3. VIEWER: Read-only access - can only view dashboards and reports, no editing capabilities
 *
 * Data Structure:
 * - /users/{userId}: User profiles with role field (master/admin/viewer)
 * - /users/{userId}/transactions: User's financial transactions
 * - /users/{userId}/wiseTransactions: User's Wise transactions
 * - /exchangeRates: Public exchange rate data
 * - /roles_master: Collection identifying master users (highest privilege)
 * - /roles_admin: Collection identifying admin users (management privilege)
 *
 * Permission Matrix:
 * | Action              | Master | Admin | Viewer |
 * |---------------------|--------|-------|--------|
 * | View all data       | ✓      | ✓     | ✓      |
 * | Create/Edit content | ✓      | ✓     | ✗      |
 * | Delete content      | ✓      | ✓     | ✗      |
 * | Manage users        | ✓      | ✗     | ✗      |
 * | Change roles        | ✓      | ✗     | ✗      |
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the foundation of the ownership model.
     * @param userId The user ID to check against the request's authentication UID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if a document exists AND the requester is the owner.
     * Used for safe update and delete operations.
     * @param userId The user ID to check for ownership.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Checks if the requesting user has MASTER privileges (highest level).
     * Masters can do everything including managing users and roles.
     */
    function isMaster() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_master/$(request.auth.uid));
    }

    /**
     * Checks if the requesting user has ADMIN privileges.
     * Admins can manage content but not users or roles.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Checks if the requesting user has at least ADMIN privileges (Master or Admin).
     */
    function isAdminOrAbove() {
      return isMaster() || isAdmin();
    }

    // --------------------------------------------------------------------
    // User Data Collections
    // --------------------------------------------------------------------

    /**
     * @description User profiles with role-based access
     * - Everyone can view all users (for collaboration features)
     * - Users can create their own profile
     * - Only Master can update/delete any user
     * - Users can update their own profile (except role field)
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isOwner(userId);
      allow update: if isMaster() || (isOwner(userId) && (!request.resource.data.keys().hasAny(['role']) || request.resource.data.role == resource.data.role)); // Can't change own role
      allow delete: if isMaster();
    }

    /**
     * @description Financial transactions with role-based access
     * - Users can create/update/delete their own transactions
     * - Everyone can view all transactions (for collaboration)
     * - Admins/Masters have full control over all transactions
     */
    match /users/{userId}/transactions/{transactionId} {
      allow get: if isSignedIn(); // Everyone can view
      allow list: if isSignedIn(); // Everyone can list
      allow create: if isOwner(userId) || isAdminOrAbove(); // Owner or Admin+ can create
      allow update: if isOwner(userId) || isAdminOrAbove(); // Owner or Admin+ can update
      allow delete: if isOwner(userId) || isAdminOrAbove(); // Owner or Admin+ can delete
    }

    /**
     * @description Wise transactions with role-based access
     * - Viewers: read-only access
     * - Admins: can create/update/delete
     * - Masters: full control
     */
    match /users/{userId}/wiseTransactions/{wiseTransactionId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdminOrAbove();
      allow update: if isAdminOrAbove();
      allow delete: if isAdminOrAbove();
    }

    // --------------------------------------------------------------------
    // Public & Admin Collections
    // --------------------------------------------------------------------

    /**
     * @description Exchange rates - public read, admin+ write
     */
    match /exchangeRates/{exchangeRateId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdminOrAbove();
      allow update: if isAdminOrAbove();
      allow delete: if isAdminOrAbove();
    }

    /**
     * @description Master roles - highest privilege level
     * Only masters can read this collection (to verify other masters)
     * Cannot be modified from client (must use Firebase Console or Admin SDK)
     */
    match /roles_master/{userId} {
      allow get: if isMaster();
      allow list: if isMaster();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Admin roles - management privilege level
     * Masters and admins can read this collection
     * Cannot be modified from client
     */
    match /roles_admin/{userId} {
      allow get: if isAdminOrAbove();
      allow list: if isAdminOrAbove();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

  }
}