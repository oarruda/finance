/**
 * This ruleset enforces a strict security model for a Family Finance Tracker application.
 *
 * Core Philosophy:
 * The security model is built on three-tier Role-Based Access Control:
 * 1. MASTER: Full control - can create/edit/delete everything, manage all users, configure APIs and AI
 * 2. ADMIN: Transaction management - can only view and manage transactions, cannot manage users or settings
 * 3. VIEWER: Read-only access - can only view dashboards and reports, no editing capabilities
 *
 * Data Structure:
 * - /users/{userId}: User profiles with role field (master/admin/viewer)
 * - /users/{userId}/transactions: User's financial transactions
 * - /users/{userId}/wiseTransactions: User's Wise transactions
 * - /transactionHistory: Audit log for transaction changes
 * - /exchangeRates: Public exchange rate data
 * - /settings: System settings (API keys, AI config) - MASTER only
 * - /roles_master: Collection identifying master users (highest privilege)
 * - /roles_admin: Collection identifying admin users (transaction management only)
 * - VIEWER role is implicit - any user without master or admin role
 *
 * Permission Matrix:
 * | Action                    | Master | Admin | Viewer |
 * |---------------------------|--------|-------|--------|
 * | View all data             | ✓      | ✓     | ✓      |
 * | Manage transactions       | ✓      | ✓     | ✗      |
 * | Manage users              | ✓      | ✗     | ✗      |
 * | Change roles              | ✓      | ✗     | ✗      |
 * | Configure APIs/AI         | ✓      | ✗     | ✗      |
 * | Insert demo data          | ✓      | ✗     | ✗      |
 * | View audit logs           | ✓      | ✓     | ✗      |
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the foundation of the ownership model.
     * @param userId The user ID to check against the request's authentication UID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if a document exists AND the requester is the owner.
     * Used for safe update and delete operations.
     * @param userId The user ID to check for ownership.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Checks if the requesting user has MASTER privileges (highest level).
     * Masters can do everything including managing users and roles.
     */
    function isMaster() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_master/$(request.auth.uid));
    }

    /**
     * Checks if the requesting user has ADMIN privileges.
     * Admins can manage content but not users or roles.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Checks if the requesting user has at least ADMIN privileges (Master or Admin).
     */
    function isAdminOrAbove() {
      return isMaster() || isAdmin();
    }

    // --------------------------------------------------------------------
    // User Data Collections
    // --------------------------------------------------------------------

    /**
     * @description User profiles with role-based access
     * - Everyone can view all users (for collaboration features)
     * - Users can create their own profile
     * - ONLY Masters can create profiles for other users
     * - ONLY Master can update/delete any user (ADMIN cannot)
     * - Users can update their own profile (except role and disabled fields)
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isOwner(userId) || isMaster();
      // MASTER can update anything. Users can only update their own profile but NOT role or disabled fields
      allow update: if isMaster() || 
                       (isOwner(userId) && 
                        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'disabled']));
      allow delete: if isMaster();
    }

    /**
     * @description Financial transactions with role-based access
     * - Users can create/update/delete their own transactions
     * - Everyone can view all transactions (for collaboration)
     * - Admins/Masters have full control over all transactions
     */
    match /users/{userId}/transactions/{transactionId} {
      allow get: if isSignedIn(); // Everyone can view
      allow list: if isSignedIn(); // Everyone can list
      allow create: if isOwner(userId) || isAdminOrAbove(); // Owner or Admin+ can create
      allow update: if isOwner(userId) || isAdminOrAbove(); // Owner or Admin+ can update
      allow delete: if isOwner(userId) || isAdminOrAbove(); // Owner or Admin+ can delete
    }

    /**
     * @description User settings (categories, preferences, etc.)
     * - Users can read/write their own settings
     * - Admins/Masters can read all settings
     */
    match /users/{userId}/settings/{settingId} {
      allow get: if isOwner(userId) || isAdminOrAbove();
      allow list: if isOwner(userId) || isAdminOrAbove();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Wise transactions with role-based access
     * - Users can create/update/delete their own Wise transactions
     * - Everyone can view all Wise transactions (for collaboration)
     * - Admins/Masters have full control over all Wise transactions
     */
    match /users/{userId}/wiseTransactions/{wiseTransactionId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isOwner(userId) || isAdminOrAbove();
      allow update: if isOwner(userId) || isAdminOrAbove();
      allow delete: if isOwner(userId) || isAdminOrAbove();
    }

    // --------------------------------------------------------------------
    // Public & Admin Collections
    // --------------------------------------------------------------------

    /**
     * @description Exchange rates - public read, MASTER only write
     */
    match /exchangeRates/{exchangeRateId} {
      allow get: if true;
      allow list: if true;
      allow create: if isMaster();
      allow update: if isMaster();
      allow delete: if isMaster();
    }

    /**
     * @description System settings (API keys, AI configuration)
     * - ONLY Masters can read and write
     * - ADMIN and VIEWER have no access
     */
    match /settings/{settingId} {
      allow get: if isMaster();
      allow list: if isMaster();
      allow create: if isMaster();
      allow update: if isMaster();
      allow delete: if isMaster();
    }

    /**
     * @description Transaction history/audit log
     * - ADMIN and MASTER can read audit logs
     * - System automatically creates entries (handled by Cloud Functions or client)
     * - Cannot be modified or deleted once created
     */
    match /transactionHistory/{historyId} {
      allow get: if isAdminOrAbove();
      allow list: if isAdminOrAbove();
      allow create: if isAdminOrAbove(); // Created when transactions are modified
      allow update: if false; // Audit logs are immutable
      allow delete: if isMaster(); // Only MASTER can delete audit logs if needed
    }

    /**
     * @description Master roles - highest privilege level
     * Only masters can read this collection (to verify other masters)
     * Only masters can manage other masters
     */
    match /roles_master/{userId} {
      allow get: if isMaster();
      allow list: if isMaster();
      allow create: if isMaster();
      allow update: if isMaster();
      allow delete: if isMaster();
    }

    /**
     * @description Admin roles - management privilege level
     * Masters and admins can read this collection
     * Only masters can manage admin roles
     */
    match /roles_admin/{userId} {
      allow get: if isAdminOrAbove();
      allow list: if isAdminOrAbove();
      allow create: if isMaster();
      allow update: if isMaster();
      allow delete: if isMaster();
    }

    /**
     * @description Viewer roles - read-only privilege level
     * Masters and admins can read this collection
     * Only masters can manage viewer roles
     */
    match /roles_viewer/{userId} {
      allow get: if isAdminOrAbove();
      allow list: if isAdminOrAbove();
      allow create: if isMaster();
      allow update: if isMaster();
      allow delete: if isMaster();
    }

    /**
     * @description Email templates for system emails
     * Masters can manage email templates
     * Templates are stored per master user with welcome and reset variants
     */
    match /emailTemplates/{userId} {
      allow get: if isMaster();
      allow list: if isMaster();
      allow create: if isMaster();
      allow update: if isMaster();
      allow delete: if isMaster();
    }

    /**
     * @description Support conversations
     * Users can create and read their own conversation
     * Masters can read and manage all conversations
     */
    match /supportConversations/{conversationId} {
      allow get: if isSignedIn() && (isOwner(resource.data.userId) || isMaster());
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (isOwner(resource.data.userId) || isMaster());
      allow delete: if isMaster();
    }

    /**
     * @description Support messages
     * Users can create messages in their own conversation
     * Users can read messages from their conversation
     * Masters can read and create messages in all conversations
     */
    match /supportMessages/{messageId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isMaster();
      allow delete: if isMaster();
    }

  }
}